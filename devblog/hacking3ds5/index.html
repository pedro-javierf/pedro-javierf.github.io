<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='OpenMSET, first vulnerability Now it&rsquo;s time to explain how to find an exploit blindly, or mostly blindy. In the last post we saw how to dump a piece of native dsi code running on the 3ds. This is a nice entrypoint, since it could give us code execution in the backwards compatibility mode. There are already other easier and more widespread methods to get code execution on the Nintendo DS which work for the Nintendo 3DS backwards mode, like flashcarts, or savegame hacks.'>
<meta name='theme-color' content='#6aff00'>

<meta property='og:title' content='Hacking The 3ds V: ARM Reversing, exploit chain and OpenMSET • PJ&#39;s Playground'>
<meta property='og:description' content='OpenMSET, first vulnerability Now it&rsquo;s time to explain how to find an exploit blindly, or mostly blindy. In the last post we saw how to dump a piece of native dsi code running on the 3ds. This is a nice entrypoint, since it could give us code execution in the backwards compatibility mode. There are already other easier and more widespread methods to get code execution on the Nintendo DS which work for the Nintendo 3DS backwards mode, like flashcarts, or savegame hacks.'>
<meta property='og:url' content='https://pedro-javierf.github.io/devblog/hacking3ds5/'>
<meta property='og:site_name' content='PJ&#39;s Playground'>
<meta property='og:type' content='article'><meta property='article:section' content='Devblog'><meta property='article:published_time' content='2019-07-24T19:40:38&#43;02:00'/><meta property='article:modified_time' content='2019-07-24T19:40:38&#43;02:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@pedro_javierf'>

<meta name="generator" content="Hugo 0.55.6" />

  <title>Hacking The 3ds V: ARM Reversing, exploit chain and OpenMSET • PJ&#39;s Playground</title>
  <link rel='canonical' href='https://pedro-javierf.github.io/devblog/hacking3ds5/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.cb99c271.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#6aff00;}
</style>

</head>


<body class='page type-devblog has-sidebar'>

  <div class='site'>

    <div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
    PJ&#39;s Playground
    </h2>
    <div class='desc'>
    Welcome to Pedro Javier&#39;s technollogy website
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/devblog/'>Devblog</a></li><li class='item'>
  <a href='/reviews/'>Reviews</a></li><li class='item'>
  <a href='/posts/'>Other Posts</a></li><li class='item'>
  <a href='/about/'>About</a></li></ul>
    </div>
  </nav>

</section></div>

  <div class='sidebar-overlay'></div>
</div>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/devblog/'>Devblog</a>
      </li><li class='item'>
        <a href='/reviews/'>Reviews</a>
      </li><li class='item'>
        <a href='/posts/'>Other Posts</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>PJ&#39;s Playground</p><p class='desc site-desc'>Welcome to Pedro Javier&#39;s technollogy website</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Hacking The 3ds V: ARM Reversing, exploit chain and OpenMSET</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2019-07-24T19:40:38&#43;02:00'>2019, Jul 24</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<h1 id="u-openmset-first-vulnerability-u"><u>OpenMSET, first vulnerability</u></h1>

<p>Now it&rsquo;s time to explain how to find an exploit blindly, or mostly blindy.
In the last post we saw how to dump a piece of native dsi code running on the 3ds. This is a nice entrypoint, since it could give us code execution in the backwards compatibility mode.
There are already other easier and more widespread methods to get code execution on the Nintendo DS which work for the Nintendo 3DS backwards mode, like flashcarts, or savegame hacks. Those allow us to run homebrew, and I will show how to get a savegame hack COMPLETELY BLINDLY in part 5.</p>

<p>Now as for the target, it is specially useful when seeking for exploits, to see what native 3ds code interacts with whatever runs in the backward mode. This could be, the <em>home menu</em> which loads images and texts from the titles, or&hellip; the <em>system settings</em>, which displays the nickname and a user motto used for Nintendo DS games that run in backwards mode. We can change the motto/description value, and it is a string, which is up to 20 characters.
This can also be changed from a homebrew, since in the original Nintendo DS everything used to run in the baremetal and this specific fields were stored in a flash memory, unprotected, this means whatever code executes in DS mode is capable of changing the DS username, for example. This settings were saved in a flash memory, and in the 3ds they are likely stored somewhere in some file in the NAND. Either way, the values were reversed and documented for the NDS in <a href="https://problemkaputt.de/gbatek.htm#dsfirmwareusersettings" target="_blank">gbatek</a></p>

<p>Here is some interesting information about our possible target:</p>

<p><code>
Addr Size Expl.<br>
  000h  2   Version (5) (Always 5, for all NDS/DSi Firmware versions)<br>
  002h  1   Favorite color (0..15) (0=Gray, 1=Brown, etc.)<br>
  003h  1   Birthday month (1..12) (Binary, non-BCD)<br>
  004h  1   Birthday day   (1..31) (Binary, non-BCD)<br>
  005h  1   Not used (zero)<br>
<strong>006h  20  Nickname string in UTF-16 format            &lt;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</strong> <br>
<strong>01Ah  2   Nickname length in characters    (0..10)    &lt;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</strong><br>
  01Ch  52  Message string in UTF-16 format<br>
  050h  2   Message length in characters     (0..26)<br>
  052h  1   Alarm hour     (0..23) (Binary, non-BCD)<br>
  053h  1   Alarm minute   (0..59) (Binary, non-BCD)<br>
  &hellip;<br></code></p>

<p>There are two interesting fields:</p>

<p><code>
<strong>006h  20  Nickname string in UTF-16 format</strong> <br></code>
This one located at offset 0x006 is 20 bytes in size. It is the Nickname string used in DS mode which is displayed in the 3ds backwards mode!</p>

<p><code>
<strong>01Ah  2   Nickname length in characters    (0..10)</strong> <br></code>
Located at 0x01A with a size of 2 bytes we find a value that holds the lenght of the nickname&hellip;</p>

<p>If you have some knowledge on exploit development then a bell might have went off; this looks like the classic overflowable string in the stack, which causes a stack overflow vulnerability! By modifying the <em>length</em> value in ways the programmers didn&rsquo;t expect, we can induce some unintended behaviour. I won&rsquo;t go into explaining how a stack buffer overflow / stack smash vulnerability works. I will just try to trigger it and see if it crashes the console!</p>

<p>For this, we&rsquo;ll use the OpenMSET code to fuzz the <em>length</em> value, for example, setting it to a very high value.</p>

<p>The Nickname length field is two bytes, so let&rsquo;s set them to the maximum value possible 0xFF 0xFF:</p>

<p><code>
  iprintf(&ldquo;Fuzzing shMessageLength..\n&rdquo;);<br>
  workbuffer[0x1A] = 0xFF;<br>
  workbuffer[0x1A+0x1] = 0xFF;<br></p>

<p>iprintf(&ldquo;Fuzzing shMessageLength2..\n&rdquo;);<br>
  workbuffer[0x100 + 0x1A] = 0xFF;<br>
  workbuffer[0x100 + 0x1A+0x1] = 0xFF;<br></code></p>

<p>If you are not familiar with the code of OpenMSET yet: workbuffer is just an array in which we read the firmware stuff from the flash memory into our program. Then it is modified and written again to the flash.
In this case, I&rsquo;m setting bytes 0x1A and 0x1B (two bytes) to the value 0xFF. I&rsquo;m doing the same at offset 0x100 and 0x101, which is a copy of the data that the firmware stores. If both copies aren&rsquo;t equal, it means one may be corrupted, and the data will be considered corrupt, that&rsquo;s why I&rsquo;m applying the same modifications twice in different offsets.</p>

<p>Finally, the NDS used a very basic checksum to ensure data integrity. It is a checksum code present in the BIOS and can be used with <em>ndslib</em> homebrew libs too:</p>

<p><code>
  //Patch the CRC of the first User Settings<br>
  iprintf(&ldquo;Patching checksum 1&hellip; &ldquo;);<br>
  userSettingsCRC(workbuffer);<br>
  iprintf(&ldquo;Done.\n&rdquo;);<br></code>
<br>
<code>
  //Patch the CRC of the second User Settings<br>
  iprintf(&ldquo;Patching checksum 2&hellip; &ldquo;);<br>
  userSettingsCRC(workbuffer+256);<br></code></p>

<p>Let&rsquo;s compile the code and run it on real hardware!
As the way to execute unsigned code I will just use a flashcart for the sake of simplicity:</p>

<p>YOUTUBE VIDEO HERE</p>

<h1 id="conclusions">Conclusions</h1>

<p>See you soon! Next post I will go backwards to show how to get ANOTHER blind entrypoint in NDS mode, based on the work of Micah, and trying to build it myself! In addition, we&rsquo;ll do some nice software reversing, patching checksums and finding more vulns!
We are getting close to native 3DS code execution!</p>

</div>

  
<footer class='entry-footer'>
  
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/devblog/hacking3ds4/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Hacking The 3ds IV: Hardware attacks</a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/pedro-javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/pedro_javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:pedro-javierf@pm.me' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/pedro-javier-fern%c3%a1ndez-29a998101' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2018-2019 Pedro Javier Fernández </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.9daad1e6.js'></script><script src='/js/custom.js'></script>
</body>

</html>

