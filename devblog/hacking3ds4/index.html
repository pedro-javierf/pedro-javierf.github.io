<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Introduction On this post I will talk about three different subjects, close to 3ds hacking but certainly related to distint attack surfaces. These are, first, hardware attacks explained (finally!) with the best possible examples and attempts of implementations, next, the finding of a vulnerability in native 3ds mode through backwards compatibility, and finally, I show the result of reversing Gateway 3DS 1.0 step by step with explanation, showing how it is possible to understand ac &ldquo;proffesional&rdquo; implementation of the exploit found before.'>
<meta name='theme-color' content='#6aff00'>

<meta property='og:title' content='Hacking The 3ds IV: Hardware attacks, OpenMSET, and Gateway Reversing • PJ&#39;s Playground'>
<meta property='og:description' content='Introduction On this post I will talk about three different subjects, close to 3ds hacking but certainly related to distint attack surfaces. These are, first, hardware attacks explained (finally!) with the best possible examples and attempts of implementations, next, the finding of a vulnerability in native 3ds mode through backwards compatibility, and finally, I show the result of reversing Gateway 3DS 1.0 step by step with explanation, showing how it is possible to understand ac &ldquo;proffesional&rdquo; implementation of the exploit found before.'>
<meta property='og:url' content='https://pedro-javierf.github.io/devblog/hacking3ds4/'>
<meta property='og:site_name' content='PJ&#39;s Playground'>
<meta property='og:type' content='article'><meta property='article:section' content='Devblog'><meta property='article:published_time' content='2019-03-29T19:35:38&#43;02:00'/><meta property='article:modified_time' content='2019-03-29T19:35:38&#43;02:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@pedro_javierf'>

<meta name="generator" content="Hugo 0.41" />

  <title>Hacking The 3ds IV: Hardware attacks, OpenMSET, and Gateway Reversing • PJ&#39;s Playground</title>
  <link rel='canonical' href='https://pedro-javierf.github.io/devblog/hacking3ds4/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.cb99c271.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#6aff00;}
</style>

</head>


<body class='page type-devblog has-sidebar'>

  <div class='site'>

    <div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
    PJ&#39;s Playground
    </h2>
    <div class='desc'>
    Welcome to Pedro Javier&#39;s technollogy website
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/devblog/'>Devblog</a></li><li class='item'>
  <a href='/reviews/'>Reviews</a></li><li class='item'>
  <a href='/posts/'>Other Posts</a></li><li class='item'>
  <a href='/about/'>About</a></li></ul>
    </div>
  </nav>

</section></div>

  <div class='sidebar-overlay'></div>
</div>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/devblog/'>Devblog</a>
      </li><li class='item'>
        <a href='/reviews/'>Reviews</a>
      </li><li class='item'>
        <a href='/posts/'>Other Posts</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>PJ&#39;s Playground</p><p class='desc site-desc'>Welcome to Pedro Javier&#39;s technollogy website</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Hacking The 3ds IV: Hardware attacks, OpenMSET, and Gateway Reversing</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2019-03-29T19:35:38&#43;02:00'>2019, Mar 29</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
8 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<h1 id="introduction">Introduction</h1>

<p>On this post I will talk about three different subjects, close to 3ds hacking but certainly related to distint attack surfaces. These are, first, hardware attacks explained (finally!) with the best possible examples and attempts of implementations, next, the finding of a vulnerability in native 3ds mode through backwards compatibility, and finally, I show the result of reversing Gateway 3DS 1.0 step by step with explanation, showing how it is possible to understand ac &ldquo;proffesional&rdquo; implementation of the exploit found before.
In addition, I have tried to create a post which explains with the maximum level of detail each attack / reversing step. I consider this useful as a learning resource for future generations. Moreover, it should also work as preservation for a lot of 3ds &ldquo;scene&rdquo; content back from as soon as 2011, which is getting lost and dissapearing from internet; this includes images, posts, and the addition of my explanations.</p>

<h1 id="hardware-attacks">Hardware Attacks</h1>

<p>A few years ago when I posted the first article about 3ds hacking I considered hardware hacking to be an obscure and complex learning field. Luckily, I&rsquo;m very satisfied with what I have learned so far, and it no longer looks so frustrating. This has been possible because I have spent a certain amount of spare time investigating and learning, and also unexpectedly thanks to university, where I&rsquo;m getting a lot of information about computer architecture. I want the reader to be able to learn about all of this (or at least the basis).</p>

<p>The architecture of any console, like the 3ds, is composed by different electronics or hardware components. Depending on the information flowing through this components, we could consider them interesting for hacking. If we can attack a component and extract its information, we say we have a working hardware attack. Of course there are tons of variations, so, to begin with, I will explain in general the concept of each attack and then apply the abstract idea to our target, the Nintendo 3DS.</p>

<h4 id="nand-dumping">Nand Dumping</h4>

<p>For preservation purposes, I will start talking about Nand dumps. These have been a recurrent topic in the 3ds scene over the years.</p>

<h5 id="what-is-a-nand-memory">What is a <em>NAND</em> memory?</h5>

<p>A NAND memory is just a kind of <a href="https://en.wikipedia.org/wiki/Flash_memory#NAND_flash" target="_blank">flash memory chip</a> based on NAND <a href="https://en.wikipedia.org/wiki/Logic_gate" target="_blank">logic gates</a>.
As we saw in the first post, the 3ds uses a 1GB Samsung Nand Chip.</p>

<p>For example, SD Cards are NAND memories, just that these are removable, while the 3ds one is soldered.</p>

<p><center>
<img src=img/SD_pinout.jpg>
</center><br></p>

<p>Explaining how flash memories are designed internally is just out of the scope of this post. So as for now, just consider <em>how</em> they work, and that often we only need the following 5 pins to do something useful with it:<br><br>
* <em>CMD I/O</em> (address input)<br>
* One data line, for example <em>DAT0</em> (to read the content in the memory address passed through the <em>CMD I/O</em>)<br>
*  <em>CLK</em> which is the clock signal<br>
*  <em>VDD</em> and <em>GND</em> to supply electricity to the chip.<br><br>
<strong>Normally</strong> with only those lines we are able to put the NAND memory in read mode and dump it&rsquo;s contents. But different chips may required more lines.</p>

<p>In the 3ds, this pins of the NAND chip were connected to the board and so, we could solder to some pads or components in the board which were indirectly or directly connected to the NAND memory. This means there is no need to desolder the flash just to read it (and usually the chips are difficult to desolder and may break if you try to do it!).</p>

<p>This is the pinout for the Old3DS:</p>

<p><center>
<img src=img/O3DSpinout1.png>
<img src=img/O3DSpinout2.png><br>
Main pins required, and an alternative pin for CLK in another part of the board.
</center><br></p>

<p>Notice there is no VDD pin. This is because it is unnecesary. The chip will be powered properly if we turn the console on.
As a bonus example, here is the pinout for the Nintendo DSi:</p>

<p><center>
<img src=img/DSiSideBNANDPinout.png>
<img src=img/DSiXLSideBNANDPinout.png>
Main pins required, and an alternative pin for DAT0 in another part of the board. (Top Dsi, Bottom DsiXL)
</center><br></p>

<p>The final issue is getting to dump the contents to a PC. How we do this? That&rsquo;s actually the most simple part of all.</p>

<p><center>
<img src=img/SD_Reader.jpg>
</center><br></p>

<p>The concept is simple; microSD cards are one kind of NAND flash memory. And SD cards are another kind of NAND flash. An adapter from microSD to SD just connects the pins of the microSD to the ones according to the SD standard. Now, the chip on the 3ds is just <strong>another</strong> kind of NAND memory flash. By connecting its pins to ones of the size of an SD card, we can just plug it to an SD reader in any computer. As you can see in the picture above this can be done with and microSD to SD adapter. And that&rsquo;s it! The NAND will now appear on the PC as if it were a raw drive, we can just dump with <em>dd</em> (linux) or <em>win32diskImager</em> (windows).</p>

<p>NOTE: Some extra <em>DATX</em> pins can also used in the hardmod, so it is possible to write back to the memory (i.e. restore a NAND backup).</p>

<h4 id="ram-sniffing-ram-tracing">RAM Sniffing / RAM tracing</h4>

<p>While the NAND read-write was simple, now I&rsquo;ll feature a more complex attack. The concept is straightforward; either intercept the bus lines connecting the RAM chip to the board and trace writes and reads generating an &ldquo;image&rdquo; of the memory (attack 1) or hook up to the RAM chip control lines and memory read lines, to dump the whole contents at a given moment (attack 2).</p>

<p>The only known console-hacking related attack of this type for idea one was done by scamlime; she did it with the DSi&rsquo;s RAM; find more information
<a href="https://scanlime.org/category/projects/dsi/" target="_blank">here</a>
<a href="https://www.flickr.com/search/?user_id=22238428%40N05&amp;view_all=1&amp;text=dsi" target="_blank">here</a>
<a href="https://forum.gbadev.org/viewtopic.php?t=16752&amp;sid=3b27fe4b607fc157d24855fb6ef9c1d4" target="_blank">and here</a></p>

<p>As for the second attack, it requires a bit more of hardware. Specially the use of an <a href="https://es.wikipedia.org/wiki/Field-programmable_gate_array" target="_blank">FPGA</a>. We can create a setup to sniff the traffic as in attack 1, or (warning: untested) hook up to the chip lines. Scanlime&rsquo;s work is by far the most open and documented setup. Nevertheless I consider interesting to mention the work of neimod, who presumably was the first person ever to hack the 3ds. As far as I can tell from the following pictures of his work (now dissapeared from the web) we used a custom fpga and hooked the chip directly:</p>

<p><center>
<img src=img/neimod1.jpg>
<img src=img/neimod2.jpg>
<img src=img/neimod3.jpg>
<img src=img/neimod4.jpg>
<img src=img/neimod5.jpg>
<img src=img/neimod6.jpg>
<img src=img/neimod7.jpg>
<img src=img/neimod8.jpg>
<img src=img/neimod9.jpg>
<img src=img/neimodA.jpg>
<img src=img/neimodB.jpg>
<img src=img/neimodC.jpg>
<img src=img/neimodD.jpg>
<img src=img/neimodE.jpg>
<br>
</center><br></p>

<p>Unfortunately it is believed that neimod sold all his work. Later all the pictures were deleted but you can still see here some of the soldering work and setup used.</p>

<p><em>NOTE: I&rsquo;m not really sure about the truthfulness of the image that says #Opening JTAG&hellip; Either it is fake and whoever posted it tried to fool by saying he/she connected to the 3ds using JTAG(which is not possible since it was likely removed), or someone was able to restore the JTAG connections and the JTAG debugger was not removed after all, or maybe that&rsquo;s the debug output from a FPGA&hellip; who knows.</em></p>

<h4 id="glitch-attacks-fault-injection">Glitch attacks / fault injection</h4>

<p>This attack vector has, in my humble opinion, the most simple concept yet the most extense and complex implementations. The idea is to introduce glitches (or faults) into the processor (bascially a very advanced state machine) so it is possible to skip instructions, change execution flow, dump keys and secrets, etc.
There has been <a href="https://arxiv.org/pdf/1802.00359.pdf" target="_blank">successful glitch attacks</a> to the 3DS bootrom in the last years.</p>

<p><center>
<iframe width="420" height="315" src="http://www.youtube.com/embed/6Pf3pY3GxBM" frameborder="0" allowfullscreen></iframe><br>
Practical example of a glitch attack.
</center></p>

<p>It is interesting to consider that there exists specific hardware to design and perform glitch attacks, like the <a href="https://newae.com/tools/chipwhisperer/" target="_blank">Chipwhisperer</a> though it is expensive and usually more extra hardware is needed.
I cannot dive into more detail, since I haven&rsquo;t performed a glitch attack myself yet.</p>

<h1 id="openmset-first-vulnerability">OpenMSET, first vulnerability</h1>

<p>Now it&rsquo;s time to explain how to find an exploit blindly, or mostly blindy.
In the last post we saw how to dump a piece of native dsi code running on the 3ds. This is a nice entrypoint, since it could give us code execution in the backwards compatibility mode.
There are already other easier and more widespread methods to get code execution on the Nintendo DS which work for the Nintendo 3DS backwards mode, like flashcarts. Those allow us to run homebrew.</p>

<p>Now as for the target, it is specially useful when seeking for exploits, to see what native 3ds code interacts with whatever runs in the backward mode. This could be, the <em>home menu</em> which loads images and texts from the titles, or&hellip; the <em>system settings</em>, which displays the nickname and a user motto used for Nintendo DS games that run in backwards mode. We can change the motto/description value, and it is a string, which is up to 20 characters.
This can also be changed from a homebrew, since in the original Nintendo DS everything used to run in the baremetal and this remains unchanged, this means whatever code executes is capable of changing the username, for example. This settings were saved in a flash memory, and in the 3ds they are likely stored somewhere in some file in the NAND. Either way, the values were reversed and documented for the NDS in <a href="fasdfa" target="_blank">this web</a></p>

<p>Here is some interesting target:</p>

<p><code>
Addr Size Expl.<br>
  000h  2   Version (5) (Always 5, for all NDS/DSi Firmware versions)<br>
  002h  1   Favorite color (0..15) (0=Gray, 1=Brown, etc.)<br>
  003h  1   Birthday month (1..12) (Binary, non-BCD)<br>
  004h  1   Birthday day   (1..31) (Binary, non-BCD)<br>
  005h  1   Not used (zero)<br>
  006h  20  Nickname string in UTF-16 format            <strong>&lt;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</strong> <br>
  01Ah  2   Nickname length in characters    (0..10)    <strong>&lt;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</strong><br>
  01Ch  52  Message string in UTF-16 format<br>
  050h  2   Message length in characters     (0..26)<br>
  052h  1   Alarm hour     (0..23) (Binary, non-BCD)<br>
  053h  1   Alarm minute   (0..59) (Binary, non-BCD)<br>
  &hellip;<br>
</code></p>

<h1 id="reverse-engineering-gateway-3ds">Reverse Engineering Gateway 3DS</h1>

<h1 id="conclusions">Conclusions</h1>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  
  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/devblog/hacking3ds3/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Hacking The 3ds III: Browsing the memory</a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><div id='submission-success' class='comment-submission-feedback'>
  <h4>Thank You!</h4>
  <span>Your comment has been submitted. It will appear on this page shortly!</span>
  <a href='#comments' class='button'>OK</a>
</div>

<div id='submission-failure' class='comment-submission-feedback'>
  <h4>Yikes, Sorry!</h4>
  <span>Error occured. Couldn&#39;t submit your comment. Please try again. Thank You!</span>
  <a href='#comments' class='button'>OK</a>
</div>




<div id='respond' class='comment-respond'>
  <h4 class='comment-reply-title'>Leave a comment<small>
      <a rel='nofollow' id='cancel-comment-reply-link' href='#respond' class='button' style='display:none' aria-label='Cancel comment'>Cancel</a>
    </small>
  </h4>
  <form action='https://api.staticman.net/v2/entry/pedro-javierf/pedro-javierf.github.io/master/data/comments' method='post' id='comment-form' class='comment-form'>
    
    <input type='hidden' name='options[postId]' value='59c4489c0c717379dbee752663ced35c'>
    <input type='hidden' name='options[redirect]' value='https://pedro-javierf.github.io/devblog/hacking3ds4/#submission-success'>
    <input type='hidden' name='options[redirectError]' value='https://pedro-javierf.github.io/devblog/hacking3ds4/#submission-failure'>

    <input type='hidden' name='fields[permalink]' value='/devblog/hacking3ds4/'>
    <input type='hidden' name='fields[parent_id]' value=''>

    <div>
      <label for='comment'>Comment*</label>
      <textarea id='comment' name='fields[content]' required rows='3'></textarea>
    </div>
    <div>
      <label for='name'>Name*</label>
      <input id='name' name='fields[author]' type='text' required>
    </div>
    <div>
      <label for='email'>Email*</label>
      <input id='email' name='fields[email]' type='email' required>
    </div>
    <div>
      <label for='url'>Website</label>
      <input id='url' name='fields[site]' type='url'>
    </div>
    <div>
      <button type='submit'>Comment!</button>
    </div>
  </form>
</div>

</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/pedro-javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/pedro_javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:pedro-javierf@pm.me' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/pedro-javier-fern%c3%a1ndez-29a998101' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2018-2019 Pedro Javier Fernández </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.9daad1e6.js'></script><script src='/js/custom.js'></script>
</body>

</html>

