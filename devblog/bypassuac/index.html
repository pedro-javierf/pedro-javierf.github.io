<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Hello My Fellow Readers!
Today I&rsquo;m back to write about UAC bypassing, that amazing scene that malware writers love.
 What is UAC?
Since windows vista, Microsoft implemented the so called User Account Control (UAC); a mechanism which manages processes privileges. Basically, if you have a windows account which has administrator rights, and you run an application that doesn&rsquo;t requiere administrator rights, UAC will drop the unnecessary privilges; This is done to avoid malwares having full control of the computer if they get code execution; to get admin rights UAC will prompt a question windows which will ask the user for permission, making malwares&rsquo; job harder.'>
<meta name='theme-color' content='#6aff00'>

<meta property='og:title' content='Twicexploit: Windows UAC Bypass • PJ&#39;s Playground'>
<meta property='og:description' content='Hello My Fellow Readers!
Today I&rsquo;m back to write about UAC bypassing, that amazing scene that malware writers love.
 What is UAC?
Since windows vista, Microsoft implemented the so called User Account Control (UAC); a mechanism which manages processes privileges. Basically, if you have a windows account which has administrator rights, and you run an application that doesn&rsquo;t requiere administrator rights, UAC will drop the unnecessary privilges; This is done to avoid malwares having full control of the computer if they get code execution; to get admin rights UAC will prompt a question windows which will ask the user for permission, making malwares&rsquo; job harder.'>
<meta property='og:url' content='https://pedro-javierf.github.io/devblog/bypassuac/'>
<meta property='og:site_name' content='PJ&#39;s Playground'>
<meta property='og:type' content='article'><meta property='article:section' content='Devblog'><meta property='article:published_time' content='2017-05-31T11:39:11&#43;02:00'/><meta property='article:modified_time' content='2017-05-31T11:39:11&#43;02:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@pedro_javierf'>

<meta name="generator" content="Hugo 0.41" />

  <title>Twicexploit: Windows UAC Bypass • PJ&#39;s Playground</title>
  <link rel='canonical' href='https://pedro-javierf.github.io/devblog/bypassuac/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.cb99c271.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#6aff00;}
</style>

</head>


<body class='page type-devblog has-sidebar'>

  <div class='site'>

    <div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
    PJ&#39;s Playground
    </h2>
    <div class='desc'>
    Welcome to Pedro Javier&#39;s technollogy website
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/devblog/'>Devblog</a></li><li class='item'>
  <a href='/reviews/'>Reviews</a></li><li class='item'>
  <a href='/posts/'>Other Posts</a></li><li class='item'>
  <a href='/about/'>About</a></li></ul>
    </div>
  </nav>

</section></div>

  <div class='sidebar-overlay'></div>
</div>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/devblog/'>Devblog</a>
      </li><li class='item'>
        <a href='/reviews/'>Reviews</a>
      </li><li class='item'>
        <a href='/posts/'>Other Posts</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>PJ&#39;s Playground</p><p class='desc site-desc'>Welcome to Pedro Javier&#39;s technollogy website</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Twicexploit: Windows UAC Bypass</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-05-31T11:39:11&#43;02:00'>2017, May 31</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Hello My Fellow Readers!<br />
Today I&rsquo;m back to write about UAC bypassing, that amazing scene that malware writers love.<br /><br /></p>

<p><h2>    What is UAC?</h2><br>
Since windows vista, Microsoft implemented the so called User Account Control (UAC); a mechanism which manages processes privileges. Basically, if you have a windows account which has administrator rights, and you run an application that doesn&rsquo;t requiere administrator rights, UAC will drop the unnecessary privilges; This is done to avoid malwares having full control of the computer if they get code execution; to get admin rights UAC will prompt a question windows which will ask the user for permission, making malwares&rsquo; job harder.</p>

<p><h2>    How does it work?</h2><br>
The bypass is achieved using two different exploits or failures; In windows vista, UAC prompts were really annoying for the users so Microsoft decided that, starting in win7, applications(.EXEs) signed by Microsoft would be able to auto-elevate privileges. What does this means? when it comes to running them, they will not show any pop-up windows asking for credentials. Some of this apps and services are the ones that are located in the C:\Windows\System32 folder. The goal is to get code execution on any of these, but how? Since this apps will automatically elevate their privileges when they start, this means that we can&rsquo;t use code injection techniques from an userland process, because we wouldn&rsquo;t have enough privileges.<br /><br />
I will instead be using a method called &lsquo;dll hijacking&rsquo;; This is mainly replacing legit .dll files by our own .dll files but renamed with the original name, so programs will load it believing it is the original. Unfortunately, there are some issues to solve first; The autoelevated application we are going to hijack is stored at System32, a system critical/protected location, so it means we can&rsquo;t write there if we don&rsquo;t have privileges (which is exactly what we are trying to obtain with our exploit). Or not; Thanks to a design flaw, certain specific processes, running in userland, have some extra special privileges. This applies for explorer.exe, for example. Among other special privileges, explorer.exe is able to call the IFileOperation interface, which is part of COM, with admin-like privileges.<br />
<br>
Therefore, the first step is really getting code execution in the explorer.exe process. You will need to inject code with any technique you are comfortable with (old reliable dll injection does the trick, by the way).
<br />We&rsquo;ll copy then our crafted dll to the system32 folder with the name &lsquo;ntwdblib.dll&rsquo; which is a dll that the program &lsquo;cliconfg.exe&rsquo; runs (this is one of those auto elevated programs I&rsquo;ve just explained). <br> Here concludes stage one.<br>
Then we&rsquo;ll run cliconfg.exe which will first autoelevate to admin rights, and next it will load our dll&rsquo;s entrypoint. That is stage2 or vulnerability 2. Once the Dll is loaded, we will have code running in the context of an elevated process! Success!</p>

<p><h2>    Credits</h2><br>
This exploit has been developed based on ideas posted on the web by several people;
Thanks to the first person who exploited dll hijacking, and the one who found this auto-elevated processes and listed them.</p>

<p><h2>    Disclaimer</h2><br>
Since I originally wrote the article, more complex and efficient ways of bypassing UAC have appeared. Some of them are now able to bypass it in only one stage
or in a faster way. Nevertheless, Twicexploit was one of the first open source implementations available. All the code (Code injector, stage1, stage2) is available in github: <a href="https://github.com/pedro-javierf/Twicexploit" target="_blank">https://github.com/pedro-javierf/Twicexploit</a></p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  
  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='next-entry sep-before'>
      <a href='/devblog/hacking3ds2/'>
        <span class='screen-reader-text'>Next post: </span>Hacking The 3ds II: Finding the Pattern<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><div id='submission-success' class='comment-submission-feedback'>
  <h4>Thank You!</h4>
  <span>Your comment has been submitted. It will appear on this page shortly!</span>
  <a href='#comments' class='button'>OK</a>
</div>

<div id='submission-failure' class='comment-submission-feedback'>
  <h4>Yikes, Sorry!</h4>
  <span>Error occured. Couldn&#39;t submit your comment. Please try again. Thank You!</span>
  <a href='#comments' class='button'>OK</a>
</div>




<div id='respond' class='comment-respond'>
  <h4 class='comment-reply-title'>Leave a comment<small>
      <a rel='nofollow' id='cancel-comment-reply-link' href='#respond' class='button' style='display:none' aria-label='Cancel comment'>Cancel</a>
    </small>
  </h4>
  <form action='https://api.staticman.net/v2/entry/pedro-javierf/pedro-javierf.github.io/master/data/comments' method='post' id='comment-form' class='comment-form'>
    &#34;https://api.staticman.net/v2/entry/pedro-javierf/pedro-javierf.github.io/master&#34;
    <input type='hidden' name='options[postId]' value='95e43c9547425378a714a30e97f2fe74'>
    <input type='hidden' name='options[redirect]' value='https://pedro-javierf.github.io/devblog/bypassuac/#submission-success'>
    <input type='hidden' name='options[redirectError]' value='https://pedro-javierf.github.io/devblog/bypassuac/#submission-failure'>

    <input type='address' name='fields[honeypot]' style='display:none'>
    <input type='hidden' name='fields[permalink]' value='/devblog/bypassuac/'>
    <input type='hidden' name='fields[parent_id]' value=''>

    <div>
      <label for='comment'>Comment*</label>
      <textarea id='comment' name='fields[content]' required rows='3'></textarea>
    </div>
    <div>
      <label for='name'>Name*</label>
      <input id='name' name='fields[author]' type='text' required>
    </div>
    <div>
      <label for='email'>Email*</label>
      <input id='email' name='fields[email]' type='email' required>
    </div>
    <div>
      <label for='url'>Website</label>
      <input id='url' name='fields[site]' type='url'>
    </div>
    <div>
      <button type='submit'>Comment!</button>
    </div>
  </form>
</div>

</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/pedro-javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/pedro_javierf' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:pedro-javierf@pm.me' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/pedro-javier-fern%c3%a1ndez-29a998101' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2018 Pedro Javier Fernández </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.9daad1e6.js'></script><script src='/js/custom.js'></script>
</body>

</html>

